# AWS EC2 Deployment Script for Hydroponic Monitoring System
# Run these commands one by one or save as deploy.sh and execute

# Update system packages
sudo apt update && sudo apt upgrade -y

# Install required system packages
sudo apt install -y git curl build-essential python3 python3-pip python3-venv nodejs npm nginx supervisor

# Install Node.js 18 (LTS)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# Create application directory
sudo mkdir -p /opt/hydroponics
sudo chown $USER:$USER /opt/hydroponics
cd /opt/hydroponics

# Clone repository from GitHub
git clone https://github.com/YOUR_USERNAME/hydroponics-dashboard.git .
# Note: Replace YOUR_USERNAME with your actual GitHub username

# Backend Setup
cd /opt/hydroponics/backend

# Create Python virtual environment
python3 -m venv venv
source venv/bin/activate

# Install Python dependencies
pip install flask flask-socketio flask-cors sqlite3 python-socketio eventlet

# Create required directories
mkdir -p static/camera_images
mkdir -p database
mkdir -p exports

# Set permissions for directories
chmod 755 static/camera_images
chmod 755 database
chmod 755 exports

# Frontend Setup
cd /opt/hydroponics/frontend

# Install Node.js dependencies
npm install

# Build production version
npm run build

# Create systemd service for backend
sudo tee /etc/systemd/system/hydroponics-backend.service > /dev/null <<EOF
[Unit]
Description=Hydroponics Backend API
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=/opt/hydroponics/backend
Environment=PATH=/opt/hydroponics/backend/venv/bin
ExecStart=/opt/hydroponics/backend/venv/bin/python app.py
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# Create Nginx configuration
sudo tee /etc/nginx/sites-available/hydroponics > /dev/null <<EOF
server {
    listen 80;
    server_name _;

    # Frontend (React build)
    location / {
        root /opt/hydroponics/frontend/build;
        try_files \$uri \$uri/ /index.html;
    }

    # Backend API
    location /api/ {
        rewrite ^/api/(.*) /\$1 break;
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # WebSocket connections
    location /socket.io/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    # Static files (camera images, exports)
    location /static/ {
        alias /opt/hydroponics/backend/static/;
        expires 1h;
        add_header Cache-Control "public, immutable";
    }

    # File upload size limit (for camera images)
    client_max_body_size 10M;
}
EOF

# Enable Nginx site
sudo ln -sf /etc/nginx/sites-available/hydroponics /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# Test Nginx configuration
sudo nginx -t

# Update React API base URL for production
cd /opt/hydroponics/frontend/src/services
sudo tee api.js > /dev/null <<EOF
import axios from 'axios';

const API_BASE_URL = window.location.protocol + '//' + window.location.host + '/api';

const api = axios.create({
  baseURL: API_BASE_URL,
  timeout: 10000,
});

export const hydroUnitsAPI = {
  getSensors: (unitId) => api.get(\`/units/\${unitId}/sensors\`),
  getRelays: (unitId) => api.get(\`/units/\${unitId}/relays\`),
  updateRelay: (unitId, relayData) => api.post(\`/units/\${unitId}/relays\`, relayData),
  getSchedule: (unitId) => api.get(\`/units/\${unitId}/schedule\`),
  updateSchedule: (unitId, scheduleData) => api.post(\`/units/\${unitId}/schedule\`, scheduleData),
  getCameras: (unitId) => api.get(\`/units/\${unitId}/cameras\`),
};

export const apiUtils = {
  handleError: (error, defaultMessage = 'An error occurred') => {
    if (error.response?.data?.error) {
      return error.response.data.error;
    }
    if (error.message) {
      return error.message;
    }
    return defaultMessage;
  }
};

export default api;
EOF

# Rebuild frontend with production API configuration
cd /opt/hydroponics/frontend
npm run build

# Create log directories
sudo mkdir -p /var/log/hydroponics
sudo chown $USER:$USER /var/log/hydroponics

# Update backend app.py for production
cd /opt/hydroponics/backend
cp app.py app.py.backup

# Add production configuration to app.py
cat >> app.py << 'EOF'

if __name__ == '__main__':
    import os
    port = int(os.environ.get('PORT', 5000))
    socketio.run(app,
                host='127.0.0.1',
                port=port,
                debug=False,
                log_output=True)
EOF

# Set up firewall (allow HTTP, HTTPS, SSH)
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw --force enable

# Create backup script
sudo tee /opt/hydroponics/backup.sh > /dev/null <<EOF
#!/bin/bash
DATE=\$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/hydroponics/backups"

mkdir -p \$BACKUP_DIR

# Backup database
cp /opt/hydroponics/backend/database/*.db \$BACKUP_DIR/database_\$DATE.db 2>/dev/null || true

# Backup camera images (last 7 days)
find /opt/hydroponics/backend/static/camera_images -name "*.jpg" -mtime -7 | tar -czf \$BACKUP_DIR/images_\$DATE.tar.gz -T -

# Keep only last 30 backups
find \$BACKUP_DIR -name "*.db" -mtime +30 -delete
find \$BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "Backup completed: \$DATE"
EOF

chmod +x /opt/hydroponics/backup.sh

# Add daily backup to crontab
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/hydroponics/backup.sh >> /var/log/hydroponics/backup.log 2>&1") | crontab -

# Create log rotation configuration
sudo tee /etc/logrotate.d/hydroponics > /dev/null <<EOF
/var/log/hydroponics/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    copytruncate
}
EOF

# Start and enable services
sudo systemctl daemon-reload
sudo systemctl enable hydroponics-backend
sudo systemctl start hydroponics-backend
sudo systemctl enable nginx
sudo systemctl restart nginx

# Check service status
echo "=== Service Status ==="
sudo systemctl status hydroponics-backend --no-pager
sudo systemctl status nginx --no-pager

# Show logs
echo "=== Backend Logs ==="
sudo journalctl -u hydroponics-backend --no-pager -n 20

# Create health check script
tee /opt/hydroponics/health-check.sh > /dev/null <<EOF
#!/bin/bash
echo "=== Hydroponics System Health Check ==="
echo "Date: \$(date)"
echo

echo "Backend Service:"
sudo systemctl is-active hydroponics-backend

echo "Nginx Service:"
sudo systemctl is-active nginx

echo "API Health:"
curl -s http://localhost/api/units/DWC1/sensors > /dev/null && echo "API: OK" || echo "API: ERROR"

echo "Disk Usage:"
df -h /opt/hydroponics

echo "Memory Usage:"
free -h

echo "Database Size:"
ls -lh /opt/hydroponics/backend/database/ 2>/dev/null || echo "No database files found"

echo "Recent Camera Images:"
find /opt/hydroponics/backend/static/camera_images -name "*.jpg" -mtime -1 | wc -l | xargs echo "Images uploaded today:"
EOF

chmod +x /opt/hydroponics/health-check.sh

# Set up SSL certificate (Let's Encrypt) - Optional
# Uncomment and modify the following lines if you have a domain name:
#
# sudo apt install -y certbot python3-certbot-nginx
# sudo certbot --nginx -d yourdomain.com
# sudo systemctl enable certbot.timer

# Create update script for future deployments
tee /opt/hydroponics/update.sh > /dev/null <<EOF
#!/bin/bash
echo "Updating Hydroponics Dashboard..."

# Stop services
sudo systemctl stop hydroponics-backend

# Backup current version
cp -r /opt/hydroponics /opt/hydroponics.backup.\$(date +%Y%m%d_%H%M%S)

# Pull latest code
cd /opt/hydroponics
git pull origin main

# Update backend dependencies
cd /opt/hydroponics/backend
source venv/bin/activate
pip install -r requirements.txt 2>/dev/null || pip install flask flask-socketio flask-cors sqlite3 python-socketio eventlet

# Update frontend
cd /opt/hydroponics/frontend
npm install
npm run build

# Restart services
sudo systemctl start hydroponics-backend
sudo systemctl reload nginx

echo "Update completed!"
EOF

chmod +x /opt/hydroponics/update.sh

# Display completion message and next steps
echo "==============================================="
echo "üöÄ DEPLOYMENT COMPLETED SUCCESSFULLY!"
echo "==============================================="
echo
echo "Your Hydroponic Monitoring System is now running on:"
echo "http://$(curl -s ifconfig.me)"
echo "http://$(hostname -I | awk '{print $1}')"
echo
echo "üìã IMPORTANT NEXT STEPS:"
echo "1. Update your GitHub repository URL in the clone command above"
echo "2. Push your local code to GitHub before running this script"
echo "3. Configure your ESP32 devices to use this server's IP address"
echo "4. Set up a domain name and SSL certificate for production use"
echo
echo "üõ†Ô∏è USEFUL COMMANDS:"
echo "Health Check: /opt/hydroponics/health-check.sh"
echo "Update System: /opt/hydroponics/update.sh"
echo "View Logs: sudo journalctl -u hydroponics-backend -f"
echo "Restart Backend: sudo systemctl restart hydroponics-backend"
echo "Restart Nginx: sudo systemctl restart nginx"
echo
echo "üìÅ IMPORTANT DIRECTORIES:"
echo "Application: /opt/hydroponics"
echo "Database: /opt/hydroponics/backend/database/"
echo "Camera Images: /opt/hydroponics/backend/static/camera_images/"
echo "Logs: /var/log/hydroponics/"
echo "Backups: /opt/hydroponics/backups/"
echo
echo "üîí SECURITY REMINDERS:"
echo "- Change default passwords if any"
echo "- Set up SSL certificate for HTTPS"
echo "- Configure firewall rules as needed"
echo "- Regular backups are scheduled daily at 2 AM"
echo
echo "System is ready for ESP32 integration!"
echo "Use the API documentation in doc.txt for device integration."